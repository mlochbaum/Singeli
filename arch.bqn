# Utilities for dealing with CPU architectures

Spl â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢

# ğ•© is a list of extension dependency chains.
# Return a list of unique feature flags and dependency matrix m.
# Such that iâ€¿jâŠ‘m is 1 iff feature i depends on j.
ArchFlagAndMat â‡ {
  TSort â† {{ğ•ŠâŸ(ğ•©<â—‹â‰ âŠ¢)âŸœ(ğ•©âˆ¾Â·/ğ•¨âŠ¸<)ğ•¨âˆ¨âˆ§Â´âˆ˜âŠâŸœğ•¨Â¨p}âŸœ/0Â¨pâ†ğ•©} # Topological sort
  d â† ' ' SplÂ¨ ğ•©
  u â† â·âˆ¾d
  u âŠËœâ†© TSort âˆ¾Â¨ (âŠ¢âŠ”â—‹âˆ¾(Â¯1â†“â†‘)Â¨) (<u)âŠÂ¨d
  m â† âˆ¨Ëâˆ˜âˆ§â‰1â€¿âˆËœâŸ(âŒˆ2â‹†â¼â‰ ) (â‰¥âŒœËœâ†•âˆ˜â‰ )âŠ¸Ã—âˆ¨Â´Ã—âŒœËœÂ¨(<u)âˆŠÂ¨d    # Dependency matrix
  uâ€¿m
}

ReadNative â† {ğ•Š:
  c â† 1âŠ‘ â€¢SH "cat"â€¿"/proc/cpuinfo"
  f â† âŠ‘ "flags"âŠ¸(âŠ£â‰¡â‰ âŠ¸â†‘)Â¨âŠ¸/ (@+10) Spl c  # Line with flags"
  ((-Â´"Aa")Ã—'a'âŠ¸â‰¤)âŠ¸+ ' ' Spl 2â†“(âˆ¨`':'âŠ¸=)âŠ¸/ f
}

BaseArch â‡ { u ğ•Š feats:
  feats â†© ((-Â´"Aa")Ã—'a'âŠ¸â‰¤)âŠ¸+ âˆ¾','âŠ¸SplÂ¨ feats
  !âˆ˜(âˆ¾"Unknown features:"<âŠ¸âˆ¾' 'âˆ¾Â¨/âŸœfeats)âŸ(âˆ¨Â´) Â¬featsâˆŠuâˆ¾"NONE"â€¿"NATIVE"â€¿"ALL"
  âŸ¨uf,natâ€¿allâŸ© â† Â¯2(â†“â‹ˆâ†‘)(uâˆ¾"NATIVE"â€¿"ALL")âˆŠfeats
  nat âˆ¨â†© 0=â‰ feats
  (Â¬all)â—¶âŸ¨1Â¨, (uâˆŠReadNative)âŠ¸âˆ¨âŸnatâŸ© uf
}
