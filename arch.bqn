# CPU architecture

Spl â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢
ToUpper â† ((-Â´"Aa")Ã—'a'âŠ¸â‰¤âˆ§â‰¤âŸœ'z')âŠ¸+
TSort â† {{ğ•ŠâŸ(ğ•©<â—‹â‰ âŠ¢)âŸœ(ğ•©âˆ¾Â·/ğ•¨âŠ¸<)ğ•¨âˆ¨âˆ§Â´âˆ˜âŠâŸœğ•¨Â¨p}âŸœ/0Â¨pâ†ğ•©} # Topological sort

MakeArch â† {
  nameâ€¿widthâ€¿VecType â‡ extfileâ€¿header â† ğ•©
  Headers â‡ {(ğ•©>0)/âŸ¨headerâŸ©}
  # d is a list of extension dependency chains
  u â† â·âˆ¾ d â† ' ' SplÂ¨ â€¢file.Lines âˆ¾"data/"â€¿extfileâ€¿"_ext.txt"
  u âŠËœâ†© TSort âˆ¾Â¨ (âŠ¢âŠ”â—‹âˆ¾(Â¯1â†“â†‘)Â¨) (<u)âŠÂ¨d
  # Unique feature flags including arch name
  feats â‡ âŸ¨nameâŸ© âˆ¾ u
  # Make a dependency matrix: iâ€¿jâŠ‘m is 1 iff feature i depends on j
  GetMat â‡ {ğ•Š:
    m â† (â‰¥âŒœËœâ†•âˆ˜â‰ )âŠ¸Ã—âˆ¨Â´Ã—âŒœËœÂ¨(<u)âˆŠÂ¨d # Dependencies from file
    m âˆ¨Ëâˆ˜âˆ§â‰1â€¿âˆËœâŸ(âŒˆ2â‹†â¼â‰ )â†©        # Transitive closure
    1 âˆ¾Ë˜ 0Â¨âˆ˜âŠâŠ¸âˆ¾ m               # Plus base architecture
  }
}

arches â† MakeArchÂ¨ âŸ¨
  {
    name â‡ "X86_64"
    width â‡ 64
    extfile â‡ "x86"
    header â‡ "immintrin.h"
    VecType â‡ { ğ•Š wâ€¿vâ€¿uâ€¿f:
      "Unsupported vector type" ! âˆŠâŸœ(2â‹†6+â†•4)âŒ¾<lâ†wÃ—v  # 64â€¦512
      âŸ¨5-Ëœ2â‹†â¼l, âˆ¾âŸ¨"__m", â€¢Repr l, {Â¬f?"i";(64=w)/"d"}âŸ©âŸ©
    }
  }
  {
    name â‡ "AARCH64"
    width â‡ 64
    extfile â‡ "armv8"
    header â‡ "arm_neon.h"
    VecType â‡ { ğ•Š wâ€¿vâ€¿uâ€¿f:
      1 â‹ˆ âˆ¾âŸ¨{f?"float"; (u/"u")âˆ¾"int"}, â€¢Repr w, "x", â€¢Repr v, "_t"âŸ©
    }
  }
âŸ©

allfeats â† âˆ¾ archfeats â† {ğ•©.feats}Â¨ arches

ReadNative â† {ğ•Š:
  c â† 1âŠ‘ â€¢SH "cat"â€¿"/proc/cpuinfo"
  f â† âŠ‘ (âˆ¨Ë"flags"â€¿"Features"(âŠ£â‰¡â‰ âŠ¸â†‘)âŒœâŠ¢)âŠ¸/ (@+10) Spl c  # Line with flags
  f â†© ' ' Spl 2â†“(âˆ¨`':'âŠ¸=)âŠ¸/ f
  f â†© "pni"â€¿"bmi1"â€¿"pclmulqdq"âŠ¸âŠâŠ¸(âŠ£â—¶âŸ¨"sse3",Â¯1âŠ¸â†“,Â¯3âŠ¸â†“,âŠ¢âŸ©Â¨) f
  âˆŠâŸœ(âˆ¾allfeats)âŠ¸/ ((-Â´"._")Ã—'_'âŠ¸=)âŠ¸+ ((-Â´"Aa")Ã—'a'âŠ¸â‰¤)âŠ¸+ f
}

arg â† ToUpper âˆ¾','âŠ¸SplÂ¨ â€¢args
arg ("NATIVE"âŠ¸â‰¡Â¨ (Â¬âŠ¸/âˆ¾ReadNative)âŸ((0=â‰ )âŠ¸(âˆ¨Â´)âŠ£) âŠ¢)â†©
!âˆ˜(âˆ¾"Unknown features:"<âŠ¸âˆ¾' 'âˆ¾Â¨/âŸœarg)âŸ(âˆ¨Â´) Â¬argâˆŠallfeatsâˆ¾âŸ¨"ALL"âŸ©
"Incompatible features" ! âˆ¨Â´ supp â† argâŠ¸(âˆ§Â´âˆŠ)Â¨ archfeats
arch â† âŠ‘ supp / arches

âŸ¨width, VecType, Headers, featsâŸ© â‡ arch
mat â‡ arch.GetMat@

baseArch â‡ (âŠ‘ âŠ£â—¶âŸ¨1Â¨,âŠ¢âŸ© 1âŠ¸â†“) (âŸ¨"ALL"âŸ©âˆ¾feats)âˆŠarg

FeatInd â‡ { # ğ•¨ is 0 to allow features outside current architecture
  i â† feats âŠ ğ•©
  m â† (i=â‰ feats)/â—‹â¥Šğ•©
  !âˆ˜(âˆ¾"Unknown architecture features:"<âŠ¸âˆ¾' 'âˆ¾Â¨/âŸœm)âŸ(âˆ¨Â´) Â¬mâˆŠallfeats
  !âˆ˜(1â†“Â·âˆ¾' 'âˆ¾Â¨âŸ¨"Features not in",arch.name,"architecture:"âŸ©âˆ¾âŠ¢)âŸ(0<â‰ )âŸğ•¨ m
  i
}
