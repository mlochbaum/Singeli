# CPU architecture

Spl â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢
ToUpper â† ((-Â´"Aa")Ã—'a'âŠ¸â‰¤âˆ§â‰¤âŸœ'z')âŠ¸+
TSort â† {{ğ•ŠâŸ(ğ•©<â—‹â‰ âŠ¢)âŸœ(ğ•©âˆ¾Â·/ğ•¨âŠ¸<)ğ•¨âˆ¨âˆ§Â´âˆ˜âŠâŸœğ•¨Â¨p}âŸœ/0Â¨pâ†ğ•©} # Topological sort

MakeArch â† {
  nameâ€¿widthâ€¿VecType â‡ extfileâ€¿header â† ğ•©
  Headers â‡ {(ğ•©>0)/âŸ¨headerâŸ©}
  # d is a list of extension dependency chains
  u â† â·âˆ¾ d â† ' ' SplÂ¨ â€¢file.Lines âˆ¾"data/"â€¿extfileâ€¿"_ext.txt"
  u âŠËœâ†© TSort âˆ¾Â¨ (âŠ¢âŠ”â—‹âˆ¾(Â¯1â†“â†‘)Â¨) (<u)âŠÂ¨d
  # Unique feature flags including arch name
  feats â‡ âŸ¨nameâŸ© âˆ¾ u
  # Make a dependency matrix: iâ€¿jâŠ‘m is 1 iff feature i depends on j
  GetMat â‡ {ğ•Š:
    m â† (â‰¥âŒœËœâ†•âˆ˜â‰ )âŠ¸Ã—âˆ¨Â´Ã—âŒœËœÂ¨(<u)âˆŠÂ¨d # Dependencies from file
    m âˆ¨Ëâˆ˜âˆ§â‰1â€¿âˆËœâŸ(âŒˆ2â‹†â¼â‰ )â†©        # Transitive closure
    1 âˆ¾Ë˜ 0Â¨âˆ˜âŠâŠ¸âˆ¾ m               # Plus base architecture
  }
}

arches â† MakeArchÂ¨ âŸ¨
  {
    name â‡ "X86_64"
    width â‡ 64
    extfile â‡ "x86"
    header â‡ "immintrin.h"
    us â† "Unsupported vector type"
    VecType â‡ {
      ğ•Š 1â€¿âŸ¨vâŸ©â€¿1â€¿0: vâ‰¤64?
        us ! âˆŠâŸœ(2â‹†3+â†•4)âŒ¾<v      # 8â€¦64
        âŸ¨4, "__mmask"âˆ¾â€¢Repr vâŸ©; # AVX-512 mask
      ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f:
        us ! âˆŠâŸœ(2â‹†6+â†•4)âŒ¾<lâ†wÃ—v  # 64â€¦512
        âŸ¨5-Ëœ2â‹†â¼l, âˆ¾âŸ¨"__m", â€¢Repr l, {l=64?"";Â¬f?"i";(64=w)/"d"}âŸ©âŸ©;
      !"Nested vector type unsupported in x86"
    }
  }
  {
    name â‡ "AARCH64"
    width â‡ 64
    extfile â‡ "armv8"
    header â‡ "arm_neon.h"
    VecType â‡ {
      ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f:
        1 â‹ˆ âˆ¾âŸ¨{f?"float"; (u/"u")âˆ¾"int"}, â€¢Repr w, "x", â€¢Repr v, "_t"âŸ©;
      !"Nested vector type not yet supported in ARM"
    }
  }
  {
    name â‡ "RV64"
    width â‡ 64
    extfile â‡ "rv"
    header â‡ "riscv_vector.h"
    VecType â‡ {
      ğ•Š âŸ¨w, xâ€¿v, u, fâŸ©: 1 â‹ˆ âˆ¾âŸ¨Â¯2â†“1âŠ‘ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f, 'x', â€¢Repr x, "_t"âŸ©;
      ğ•Š 1â€¿âŸ¨vâŸ©â€¿1â€¿0:
        1 â‹ˆ âˆ¾âŸ¨"vbool", â€¢Repr 128Ã·v, "_t"âŸ©;
      ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f:
        lmul â† (vÃ—w)Ã·128
        mf â† lmul<1
        1 â‹ˆ âˆ¾âŸ¨"v", {f?"float"; (u/"u")âˆ¾"int"}, â€¢Repr w, "m", mf/"f", â€¢Repr Ã·âŸmf lmul, "_t"âŸ©;
      !"Only two levels of vector nesting supported in RISC-V"
    }
  }
âŸ©

allfeats â† âˆ¾ archfeats â† {ğ•©.feats}Â¨ arches

ReadNative â† {ğ•Š:
  f â† {
    c â† 1âŠ‘ â€¢SH "cat"â€¿"/proc/cpuinfo"
    l â† (âˆ¨Ë"flags"â€¿"Features"(âŠ£â‰¡â‰ âŠ¸â†‘)âŒœâŠ¢)âŠ¸/ (@+10) Spl c  # Line with flags
    0<â‰ l ? ToUpperÂ¨ 1â†‘l
  ;
    l â† (@+10) Spl (1âŠ‘â€¢SH)âŠâŸ¨âŸ© "sysctl"â€¿"machdep.cpu" # For macs
    0<â‰ l ? {
      âˆ¨Â´(âˆ¨Â´"feature"âŠ¸â·)Â¨l ? l
    ;
      l â† (@+10) Spl 1âŠ‘ â€¢SH "sysctl"â€¿"hw.optional" # ARM
      â‹ˆToUpper ":"âˆ¾ âˆ¾ {" "âˆ¾(âˆ§`âŒ¾âŒ½Â·Â¬âˆŠâŸœ"_.")âŠ¸/(âˆ§`':'âŠ¸â‰ )âŠ¸/ğ•©}Â¨ ('0'â‰ âŠ¢Â´Â¨)âŠ¸/ l
    }
  ;
    ! "Couldn't find CPU features"
  }
  f â†© âˆ¾ (' ' Spl 2â†“(âˆ¨`':'âŠ¸=)âŠ¸/)Â¨ f
  f â†© "PNI"â€¿"BMI1"â€¿"PCLMULQDQ"â€¿"AVX1.0"âŠ¸âŠâŠ¸(âŠ£â—¶âŸ¨"SSE3",Â¯1âŠ¸â†“,Â¯3âŠ¸â†“,Â¯3âŠ¸â†“,âŠ¢âŸ©Â¨) f
  âˆŠâŸœallfeatsâŠ¸/ ((-Â´"._")Ã—'_'âŠ¸=)âŠ¸+ f
}

MaybeNat â† "NATIVE"âŠ¸â‰¡Â¨ (Â¬âŠ¸/âˆ¾ReadNative)âŸ((0=â‰ )âŠ¸(âˆ¨Â´)âŠ£) âŠ¢
arg â† âŸ¨"NONE"âŸ©âŠ¸â‰¢â—¶âŸ¨âŸ©â€¿MaybeNat ToUpper â€¢args
all â† "ALL"âŠ¸â‰¡Â¨ arg
!âˆ˜(âˆ¾"Unknown features:"<âŠ¸âˆ¾' 'âˆ¾Â¨/âŸœarg)âŸ(âˆ¨Â´) Â¬allâˆ¨argâˆŠallfeats
"Incompatible features" ! âˆ¨Â´ supp â† (allÂ¬âŠ¸/arg)âŠ¸(âˆ§Â´âˆŠ)Â¨ archfeats
arch â† âŠ‘ supp / arches

âŸ¨width, VecType, Headers, featsâŸ© â‡ arch
mat â‡ arch.GetMat@

baseArch â‡ âˆ¨Ëâˆ˜âˆ§âŸœmat (âˆ¨Â´all)â—¶âŸ¨âˆŠâŸœarg,1Â¨âŸ© feats

FeatInd â‡ { # ğ•¨ is 0 to allow features outside current architecture
  i â† feats âŠ ğ•©
  m â† (i=â‰ feats)/â—‹â¥Šğ•©
  !âˆ˜(âˆ¾"Unknown architecture features:"<âŠ¸âˆ¾' 'âˆ¾Â¨/âŸœm)âŸ(âˆ¨Â´) Â¬mâˆŠallfeats
  !âˆ˜(1â†“Â·âˆ¾' 'âˆ¾Â¨âŸ¨"Features not in",arch.name,"architecture:"âŸ©âˆ¾âŠ¢)âŸ(0<â‰ )âŸğ•¨ m
  i
}
