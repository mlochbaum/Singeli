# CPU feature processing
argfeatsâ€¿infer â† â‹ˆâŸœ0âŸ(0=â‰ ) â€¢args

archesâ€¿allfeatsâ€¿archfeatsâ€¿MakeArchâ€¿ReadNativeâ€¿ToUpper â† â€¢Import "archutil.bqn"

MaybeNat â† "NATIVE"âŠ¸â‰¡Â¨ (Â¬âŠ¸/âˆ¾ReadNative)âŸ((0=â‰ )âŠ¸(âˆ¨Â´)âŠ£) âŠ¢
arg â† âŸ¨"NONE"âŸ©âŠ¸â‰¢â—¶âŸ¨âŸ©â€¿MaybeNat ToUpper argfeats
all â† "ALL"âŠ¸â‰¡Â¨ arg
!âˆ˜(âˆ¾"Unknown features:"<âŠ¸âˆ¾' 'âˆ¾Â¨/âŸœarg)âŸ(âˆ¨Â´) Â¬allâˆ¨argâˆŠallfeats
"Incompatible features" ! âˆ¨Â´ supp â† (allÂ¬âŠ¸/arg)âŠ¸(âˆ§Â´âˆŠ)Â¨ archfeats
arch â† infer MakeArch âŠ‘ supp / arches

âŸ¨width, VecType, Headers, featsâŸ© â‡ arch
mat â‡ arch.GetMat@

baseArch â‡ âˆ¨Ëâˆ˜âˆ§âŸœmat (âˆ¨Â´all)â—¶âŸ¨âˆŠâŸœarg,1Â¨âŸ© feats

FeatInd â‡ { # ğ•¨ is 0 to allow features outside current architecture
  i â† feats âŠ ğ•©
  m â† (i=â‰ feats)/â—‹â¥Šğ•©
  !âˆ˜(âˆ¾"Unknown architecture features:"<âŠ¸âˆ¾' 'âˆ¾Â¨/âŸœm)âŸ(âˆ¨Â´) Â¬mâˆŠallfeats
  !âˆ˜(1â†“Â·âˆ¾' 'âˆ¾Â¨âŸ¨"Features not in",arch.name,"architecture:"âŸ©âˆ¾âŠ¢)âŸ(0<â‰ )âŸğ•¨ m
  i
}

# For external tools, return base architecture as C compiler flags
GetCFlags â‡ {ğ•Š:
  "-m"âŠ¸âˆ¾Â¨ ((-Â´"aA")Ã—'A'âŠ¸â‰¤âˆ§â‰¤âŸœ'Z')âŠ¸+ (baseArch âˆ§ (arch.name)âŠ¸â‰¢Â¨)âŠ¸/ feats
}
