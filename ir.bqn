# IR passes

# Apply transformation to each function
_onFns â† {
  [o,c] â† +`Ë˜ "beginFn"â€¿"endFn" (âŠ£â‰¡â‰ âŠ¸â†‘)âŒœ ğ•©
  o Â»â†©
  f â† o-c
  r â† ğ”½Â¨âŒ¾(1âŠ¸â†“) (oÃ—f)âŠ”ğ•©
  ((fÂ¬âŠ¸/o)âˆ¾/â‰ Â¨1â†“r) â‹âŠ¸âŠ âˆ¾r
}

# Attempt to replace goto{,T,F} with:
#
# - beginBlock/endBlock: a breakable code section
# - beginLoop /endLoop: jumps to beginLoop when endLoop is reached
# - break{,T,F} d: jumps to the end of loop or block at depth d
#
# Loops and blocks are properly nested, and depth 0 indicates the
# immediately enclosing section, depth 1 the one enclosing it, and so on.
# Breaking "from" a loop effectively goes to the beginning, making it
# more like a continue statement.
Restructure â‡ {
  lmâ€¿ai â† (âŠ£â‹ˆ/âˆ˜âˆ¨)Ë "lbl "â€¿"goto" â‰¡âŒœ 4â†‘Â¨ğ•©
  lb â† ai âŠ lm                # Which statements are lbl (not goto)
  id â† (âˆ§`âŒ¾âŒ½' 'âŠ¸â‰ )âŠ¸/Â¨ ai âŠ ğ•©  # Label ID
  l â† âˆŠâŒ¾âŒ½ i â† âŠ id            # Last use of label
  l â‰¡ lb?                     # Only handle forward goto
  f â† (l/i) âŠ (/âŸœiâ‹âŠ¸âŠ/) âˆŠi    # First use of label, ordered by l
  e â† f âŠ +`l                 # Next label after it
  bâ†bmâ†1â†‘e                    # Block start; bmâ‰¡âŒŠ`b
  {bâˆ¾â†©aâ†ğ•©âŠ‘bâˆ¾â‰ bâ‹„bmâˆ¾â†©aâŒŠâŠ¢Â´bmâ‹„@}Â¨ 1â†“e
  xm â† (âŸ¨"break"âˆ¾4âŠ¸â†“,"endBlock"âˆ¾3âŠ¸â†“âŸ©{ğ•Â¨ğ•©}Â¨âŠ¢)âŒ¾(lâŠ”aiâŠ¸âŠ)ğ•©
  ((bâŠfâŠai)âˆ¾â†•â‰ ğ•©) â‹âŠ¸âŠ ("beginBlock "âŠ¸âˆ¾Â¨l/id)âˆ¾xm
;
  ğ•©
}_onFns
