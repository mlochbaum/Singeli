# IR passes

# Apply transformation to each function
_onFns â† {
  [o,c] â† +`Ë˜ "beginFn"â€¿"endFn" (âŠ£â‰¡â‰ âŠ¸â†‘)âŒœ ğ•©
  o Â»â†©
  f â† o-c
  r â† ğ”½Â¨âŒ¾(1âŠ¸â†“) (oÃ—f)âŠ”ğ•©
  ((fÂ¬âŠ¸/o)âˆ¾/â‰ Â¨1â†“r) â‹âŠ¸âŠ âˆ¾r
}

# Attempt to replace goto{,T,F} with:
#
# - beginBlock/endBlock: breaks go to end       (do {...} while (0))
# - beginLoop /endLoop:  breaks go to beginning (while (1) {...;break;})
# - break{,T,F}: conditionally jump to beginning/end of a section
#
# Loops and blocks are properly nested, and have named labels.
# Since breaking "from" a loop goes to the beginning, it's more like a
# continue statement. Note that no jump happens when endLoop is reached.
Restructure â‡ {
  [lm,am] â† âˆ¨` "lbl "â€¿"goto" â‰¡âŒœ 4â†‘Â¨ğ•©
  ai â† /am
  lb â† ai âŠ lm                    # Which statements are lbl (not goto)
  i â† âŠid â† (âˆ§`âŒ¾âŒ½' 'âŠ¸â‰ )âŠ¸/Â¨ ai âŠ ğ•© # Label ID
  f â† âˆŠi â‹„ l â† âˆŠâŒ¾âŒ½i               # First and last use of label
  IM â† {(ğ•©âŠâ—‹(/âŸœi)ğ•¨) âŠ /ğ•©}         # /ğ•© ordered by matching ğ•¨ (requires ğ•¨â‰¡â—‹(âˆ§/âŸœi)ğ•©)
  ff â† (fl â† f<lb) IM lb<f        # First use of label, ordered by fl
  ll â† (bl â† lb<l) IM l<lb        # Loop start, ordered by end
  ff âŒŠâ†© {âŒŠÂ´ğ•¨â†“ğ•©â†‘ll}Â¨Ë[ff,/fl]âŠ+`bl # Surround loops where end is caught
  b â† â†•0                          # Block start
  ff {bâˆ¾â†©ğ•¨âŒŠÂ´ğ•©â†“bâ‹„@}Â¨ ff âŠ +`fl     # Surround caught blocks, iteratively
  miâ€¿liâ†2â†‘lbâŠ”ai â‹„ lisâ†âŸ¨lb/id,liâŸ©
  [nn,nm,ni] â† â‰Â¯1âŒ½[
    âŸ¨"endBlock " âŸ©âˆ¾(lb/Â¬f)âŠ¸/Â¨lis
    âŸ¨"beginBlock ", âŒ½fl/id, âŒ½bâŠaiâŸ©
    âŸ¨"beginLoop "âŸ©âˆ¾(lb/Â¬l)âŠ¸/Â¨lis
    âŸ¨"endLoop "  âŸ©âˆ¾(lb<l)âŠ¸/Â¨idâ€¿ai # Will be rotated to place after ğ•©
  ]
  alm â† Â¬lbâŒ¾(amâŠ¸/)am
  (niâˆ¾</alm) â‹âŠ¸âŠâ—‹(âˆ¾1âŠ¸âŒ½) (nn{ğ•¨âŠ¸âˆ¾Â¨ğ•©}Â¨nm)âˆ¾<alm/("break"âˆ¾4âŠ¸â†“)Â¨âŒ¾(miâŠ¸âŠ)ğ•©
  # TODO check whether that resulted in properly nested blocks
;
  ğ•©
}_onFns
