# IR passes

# Apply transformation to each function
_onFns â† {
  [o,c] â† +`Ë˜ "beginFn"â€¿"endFn" (âŠ£â‰¡â‰ âŠ¸â†‘)âŒœ ğ•©
  o Â»â†©
  f â† o-c
  r â† ğ”½Â¨âŒ¾(1âŠ¸â†“) (oÃ—f)âŠ”ğ•©
  ((fÂ¬âŠ¸/o)âˆ¾/â‰ Â¨1â†“r) â‹âŠ¸âŠ âˆ¾r
}

# Attempt to replace goto{,T,F} with two kinds of structure:
#
# - beginBlock/endBlock/break{,T,F}     (do {...} while (0))
# - beginLoop/endLoop/continue{,T,F}    (while (1) {...;break;})
#
# Loops and blocks are properly nested, and have named labels.
# Jumps only occur on break, which goes to the end of its block, and
# continue, which goes to the beginning of its loop. The loop exits when
# endLoop is reached.
Restructure â‡ {
  [lm,am] â† âˆ¨` "lbl "â€¿"goto" â‰¡âŒœ 4â†‘Â¨ğ•©
  ai â† /am
  lb â† ai âŠ lm                    # Which statements are lbl (not goto)
  i â† âŠid â† (âˆ§`âŒ¾âŒ½' 'âŠ¸â‰ )âŠ¸/Â¨ ai âŠ ğ•© # Label ID
  f â† âˆŠi â‹„ l â† âˆŠâŒ¾âŒ½i               # First and last use of label
  IM â† {(ğ•©âŠâ—‹(/âŸœi)ğ•¨) âŠ /ğ•©}         # /ğ•© ordered by matching ğ•¨ (requires ğ•¨â‰¡â—‹(âˆ§/âŸœi)ğ•©)
  ff â† (fl â† f<lb) IM lb<f        # First use of label, ordered by fl
  ll â† (bl â† lb<l) IM l<lb        # Loop start, ordered by end
  ff âŒŠâ†© {âŒŠÂ´ğ•¨â†“ğ•©â†‘ll}Â¨Ë[ff,/fl]âŠ+`bl # Surround loops where end is caught
  b â† â†•0                          # Block start
  ff {bâˆ¾â†©ğ•¨âŒŠÂ´ğ•©â†“bâ‹„@}Â¨ ff âŠ +`fl     # Surround caught blocks, iteratively
  # Place endBlock and/or beginLoop at the label, endLoop at the last goto,
  # and beginBlock at the computed location
  miâ€¿liâ†2â†‘lbâŠ”ai â‹„ lisâ†âŸ¨lb/id,liâŸ©
  [nn,nm,ni] â† â‰Â¯1âŒ½[
    âŸ¨"endBlock " âŸ©âˆ¾(lb/Â¬f)âŠ¸/Â¨lis
    âŸ¨"beginBlock ", âŒ½fl/id, âŒ½bâŠaiâŸ©
    âŸ¨"beginLoop "âŸ©âˆ¾(lb/Â¬l)âŠ¸/Â¨lis
    âŸ¨"endLoop "  âŸ©âˆ¾(lb<l)âŠ¸/Â¨idâ€¿ai # Will be rotated to place after ğ•©
  ]
  # Check that the inserted begin/end markers will be properly nested
  add â† ni â‹âŠ¸âŠâ—‹(âˆ¾1âŠ¸âŒ½) (2/Â¯1â€¿1)â‹ˆÂ¨Â¨nm            # Depth change and label
  âˆ§Â´(>â—‹âŠ‘âˆ§â‰¡â—‹(âŠ¢Â´))Â´Ë˜ âˆ˜â€¿2â¥Š ((â‹+`-0âŠ¸<)âŠ‘Â¨)âŠ¸âŠ add ?  # Abort if not nested
  # Change goto to break/continue and insert begin/end
  alm â† Â¬lbâŒ¾(amâŠ¸/)am
  br â† "break"â€¿"continue"âŠËœlbÂ¬âŠ¸/(iâŠiâ‹âŠ¸âŠâ—‹(lbâŠ¸/)âŠ¢)âŠ¸â‰¤âŠ’i
  (niâˆ¾</alm) â‹âŠ¸âŠâ—‹(âˆ¾1âŠ¸âŒ½) (nn{ğ•¨âŠ¸âˆ¾Â¨ğ•©}Â¨nm)âˆ¾<alm/(brâˆ¾âŸœ(4âŠ¸â†“)Â¨âŠ¢)âŒ¾(miâŠ¸âŠ)ğ•©
;
  ğ•©
}_onFns
