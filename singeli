#! /usr/bin/env bqn

help_pre â† 1â†“"
Compile Singeli program(s).
Argument is a list of input files and options. Supported:"

shortâ€¿longâ€¿argsâ€¿dupâ€¿desc â† <Ë˜â‰> âŸ¨
  "h" â€¿"help"  â€¿0â€¿1â€¿"Print this message and exit"
  "o" â€¿"out"   â€¿1â€¿0â€¿"Output file (print to stdout by default)"
  "oe"â€¿"errout"â€¿1â€¿0â€¿"Error to: stderr (default), stdout, none, file=path, bqn"
  "os"â€¿"show"  â€¿1â€¿0â€¿"show{} to: stdout (default), stderr, none, file=path, bqn"
# "?" â€¿"stdin" â€¿0â€¿0â€¿"Use stdin as input, after any argument files"
  "r" â€¿"run"   â€¿1â€¿1â€¿"Use this argument as source code"
  "t" â€¿"target"â€¿1â€¿0â€¿"Output type: c (default), cpp, ir"
  "a" â€¿"arch"  â€¿1â€¿1â€¿"Architecture features: list, or none, native (default), all"
  "i" â€¿"infer" â€¿1â€¿0â€¿"Type of architecture inference: strict, or loose (default)"
  "l" â€¿"lib"   â€¿1â€¿1â€¿"Library paths: lib=path to try path/x for include 'lib/x'"
  "c" â€¿"config"â€¿1â€¿1â€¿"Configuration: name=value to set config name to value"
  "p" â€¿"pre"   â€¿1â€¿0â€¿"Preamble placed before C output"
  "n" â€¿"name"  â€¿1â€¿0â€¿"Prefix for names in C output"
  "d" â€¿"deplog"â€¿1â€¿0â€¿"Output file for log of included dependencies"
âŸ©
shortâ€¿long âˆ¾ËœÂ¨âŸœ<Â¨â†© "-"â€¿"--"
args âˆ¾â†© 0

Spl â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢

c â† â‰ short
op â† (shortâŠ¸âŠ âŒŠ longâŠ¸âŠ) â€¢args
op âŒˆâ†© c Ã—Â¬ <`âŠ¸= opâŠargs
opts â† ((1+c)âˆ¾Ëœf/op) âŠ” ((op=c)(1-ËœÃ—âŸœ(+`))â—‹(âˆ¾âŸœ1)fâ†Â¬0Â»opâŠargs) âŠ” â€¢args
"Option can't be duplicated" ! âˆ§Â´ (dupâˆ¾1) â‰¥ 1<â‰ Â¨opts
olist â† (0âŒ¾âŠ‘dupâˆ¾0) (âˆ¾','âŠ¸SplÂ¨)âŸâŠ£Â¨ (1âŒ¾(Â¯1âŠ¸âŠ‘)args) âŠ£â—¶âŸ¨0<â‰ âˆ˜âŠ¢,âŠ‘Â¨âŠ¢âŸ©Â¨ opts
helpâ€¿outâ€¿oeâ€¿osâ€¿runâ€¿targetâ€¿featsâ€¿infâ€¿libâ€¿configâ€¿preâ€¿namepreâ€¿deplogâ€¿files â† olist

{ help ?
  opt_help â† âˆ¾Â¨Â´ âŸ¨descâŸ© âˆ¾Ëœ (1+Â·âŒˆÂ´â‰ Â¨)âŠ¸(â†‘Â¨)Â¨ shortâ€¿long âˆ¾Â¨Â¨ ",:"
  â€¢Out âˆ¾âˆ¾âŸœ(@+10)Â¨ âŸ¨help_pre,""âŸ© âˆ¾ opt_help
  â€¢Exit@
;@}

Rel â† â€¢wdpathâŠ¸â€¢file.At
files RelÂ¨â†©
deplog â†© @ âŠ£Â´ RelÂ¨deplog

SplitEq â† (Â»âŠ¸(âŠ£-<)Â·âˆ¨`'='âŠ¸=)âŠ¸âŠ”
libpaths â† (RelâŒ¾(1âŠ¸âŠ‘) Â¯2 â†‘ SplitEq)Â¨ lib
configs â† (2 â†‘ SplitEq)Â¨ config
_getShows â† {name _ğ•£: âŸ¨@,âŠ¢âŸ© (âŠ¢âˆ¾â‰ âŠ¸â†“Ëœ) {
  "stderr": â€¢term.ErrRawâ€¢ToUTF8âˆ¾(@+10)Ë™ ; "stdout":â€¢Out ; "none":âŠ¢ ;
  eâ†"" â‹„ Outâ†{eâˆ¾â†©ğ•©âˆ¾@+10}
  {
    "bqn": âŸ¨Out, {ğ•Š:e}âŸ© ;
    (pâ†"file=")(âŠ£â‰¡â‰ âŠ¸â†‘)ğ•©? fâ†Rel pâ‰ âŠ¸â†“ğ•© â‹„ âŸ¨Out, {ğ•Š: f â€¢file.Chars eâ‹„ğ•©}âŸ© ;
    !"Unknown "âˆ¾ğ•¨âˆ¾" output option: "âˆ¾ğ•©
  }ğ•©
}}
ToErrs â† {oeğ•ŠOâ€¿E: {"bqn"â‰¡oe ? âŸ¨O,!E,{ShowWriteâˆ˜1âˆ˜ğ”½âŠE}âŸ© ; âŸ¨O,Exit1 E,{ğ”½}âŸ©}}
âŸ¨ShowOut,ShowWriteâŸ© â† "show{}" _getShows "stdout" âŠ£Â´ os
Exit1 â† â€¢Exitâˆ˜1 âŠ£ ShowWrite
âŸ¨ErrOut,ErrExit,_withErrâŸ© â† ToErrsâŸœ("error" _getShows) "stderr" âŠ£Â´ oe

arch â† âŸ¨feats,âŸ¨"strict"âŸ©â‰¢infâŸ© â€¢Import "arch.bqn"
outputs â† ShowOutâ€¿ErrOutâ€¿ErrExit
frontend â† archâ€¿libpathsâ€¿configsâ€¿outputs â€¢Import "singeli.bqn"
backend â† {
  âŸ¨"ir"âŸ©â‰¡target ? âŠ¢ ;
  par â† âŸ¨âŸ¨"cpp"âŸ©â‰¡target,arch,"si"âŠ£Â´namepreâŸ©
  pre âŠ‘âŠ¸{ğ•¨âŠ¸ğ•}âŸ(0<â‰ âˆ˜âŠ£) par â€¢Import "emit_c.bqn"
}
output â† {
  â‰ out ? (RelâŠ‘out) â€¢file.Chars âŠ¢ ;
  â€¢OutâŸ(0<â‰ ) Â¯1âŠ¸â†“
}

{ShowWrite Output Backend âˆ¾ deplogâŠ¸FrontendÂ¨ ğ•©}_withErr (<Â¨run) âˆ¾ files
