#! /usr/bin/env bqn

help_pre â† 1â†“"
Compile Singeli program(s).
Argument is a list of input files and options. Supported:"

shortâ€¿longâ€¿argsâ€¿dupâ€¿desc â† <Ë˜â‰> âŸ¨
  "h"â€¿"help"  â€¿0â€¿1â€¿"Print this message and exit"
  "o"â€¿"out"   â€¿1â€¿0â€¿"Output file (print to stdout by default)"
# "i"â€¿"stdin" â€¿0â€¿0â€¿"Use stdin as input, after any argument files"
  "t"â€¿"target"â€¿1â€¿0â€¿"Output type: c (default), ir"
  "a"â€¿"arch"  â€¿1â€¿1â€¿"Architecture features: list, or none, native (default), all"
  "l"â€¿"lib"   â€¿1â€¿1â€¿"Library paths: lib=path to try path/x for include 'lib/x'"
  "c"â€¿"config"â€¿1â€¿1â€¿"Configuration: name=value to set config name to value"
  "p"â€¿"pre"   â€¿1â€¿0â€¿"Preamble placed before C output"
  "n"â€¿"name"  â€¿1â€¿0â€¿"Prefix for names in C output"
  "d"â€¿"deplog"â€¿1â€¿0â€¿"Output file for log of included dependencies"
âŸ©
shortâ€¿long âˆ¾ËœÂ¨âŸœ<Â¨â†© "-"â€¿"--"
args âˆ¾â†© 0

Spl â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢

c â† â‰ short
op â† (shortâŠ¸âŠ âŒŠ longâŠ¸âŠ) â€¢args
op âŒˆâ†© c Ã—Â¬ <`âŠ¸= opâŠargs
opts â† ((1+c)âˆ¾Ëœf/op) âŠ” ((op=c)(1-ËœÃ—âŸœ(+`))â—‹(âˆ¾âŸœ1)fâ†Â¬0Â»opâŠargs) âŠ” â€¢args
"Option can't be duplicated" ! âˆ§Â´ (dupâˆ¾1) â‰¥ 1<â‰ Â¨opts
os â† (0âŒ¾âŠ‘dupâˆ¾0) (âˆ¾','âŠ¸SplÂ¨)âŸâŠ£Â¨ (1âŒ¾(Â¯1âŠ¸âŠ‘)args) âŠ£â—¶âŸ¨0<â‰ âˆ˜âŠ¢,âŠ‘Â¨âŠ¢âŸ©Â¨ opts
helpâ€¿outâ€¿targetâ€¿featsâ€¿libâ€¿configâ€¿preâ€¿namepreâ€¿deplogâ€¿files â† os

{ help ?
  opt_help â† âˆ¾Â¨Â´ âŸ¨descâŸ© âˆ¾Ëœ (1+Â·âŒˆÂ´â‰ Â¨)âŠ¸(â†‘Â¨)Â¨ shortâ€¿long âˆ¾Â¨Â¨ ",:"
  â€¢Out âˆ¾âˆ¾âŸœ(@+10)Â¨ âŸ¨help_pre,""âŸ© âˆ¾ opt_help
  â€¢Exit@
;@}

Rel â† â€¢wdpathâŠ¸â€¢file.At
files RelÂ¨â†©
deplog â†© @ âŠ£Â´ RelÂ¨deplog

SplitEq â† (Â»âŠ¸(âŠ£-<)Â·âˆ¨`'='âŠ¸=)âŠ¸âŠ”
libpaths â† (RelâŒ¾(1âŠ¸âŠ‘) Â¯2 â†‘ SplitEq)Â¨ lib
configs â† (2 â†‘ SplitEq)Â¨ config

arch â† feats â€¢Import "arch.bqn"
frontend â† archâ€¿libpathsâ€¿configs â€¢Import "singeli.bqn"
backend â† {
  âŸ¨"ir"âŸ©â‰¡target ? âŠ¢ ;
  pre âŠ‘âŠ¸{ğ•¨âŠ¸ğ•}âŸ(0<â‰ âˆ˜âŠ£) archâ€¿("si"âŠ£Â´namepre) â€¢Import "emit_c.bqn"
}
output â† {
  â‰ out ? (RelâŠ‘out) â€¢file.Chars âŠ¢ ;
  â€¢Out Â¯1âŠ¸â†“
}

Output Backend âˆ¾ deplogâŠ¸FrontendÂ¨ files
