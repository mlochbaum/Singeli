# SSE
arch â† {
  Type â‡ { bTypeâ€¿wâ€¿amâ€¿ptrs:
    uâ€¿f â† bType = "uf"
    (ptrs/"*") âˆ¾Ëœ {ğ•@} {!âˆ˜"Unsupported type"} {(âŠ‘ğ•¨)â—¶âŸ¨ğ•©,1âŠ‘ğ•¨âŸ©}Â´ âŸ¨
      âŸ¨0â‰¤am     , {ğ•¤â‹„ "Unsupported type" ! 128=wÃ—am, "__m128"âˆ¾fÂ¬âŠ¸/"i" }âŸ©
      âŸ¨f        , {ğ•¤â‹„ "float"â€¿"double"âŠ‘Ëœ32â€¿64âŠ¸âŠâŒ¾<w }âŸ©
      âŸ¨w=0      , "void"âŸ©
      âŸ¨uâˆ§w=1    , "bool"âŸ©
      âŸ¨âŠ‘wâˆŠ2â‹†3+â†•4, {ğ•¤â‹„ âˆ¾(u/"u")â€¿"int"â€¿(â€¢Repr w)â€¿"_t" }âŸ©
    âŸ©
  }
}

prelude â† 1âŒ½"
#include<stdint.h>
#include<stdbool.h>
#include<xmmintrin.h>
static inline void si_aseti8 (int8_t * a, uint8_t  n, int8_t  k) { a[n]=k; }
static inline void si_aseti16(int16_t* a, uint64_t n, int16_t k) { a[n]=k; }
static inline void si_aseti32(int32_t* a, uint64_t n, int32_t k) { a[n]=k; }
static inline void si_aseti64(int64_t* a, uint64_t n, int64_t k) { a[n]=k; }
static inline int8_t  si_ageti8 (int8_t * a, uint64_t n) { return a[n]; }
static inline int16_t si_ageti16(int16_t* a, uint64_t n) { return a[n]; }
static inline int32_t si_ageti32(int32_t* a, uint64_t n) { return a[n]; }
static inline int64_t si_ageti64(int64_t* a, uint64_t n) { return a[n]; }
"

lf â† @+10

Generate â† {
  fn â† 0  # Whether a function is active
  ProcLine â† {
    line â† StartLine ğ•©
    c â† codeâŠ¸âŠâŒ¾< Name line
    (âˆ¾"Unknown operation: `"â€¿ğ•©â€¿"`") ! c<â‰ code
    depthâ€¿infnâ€¿do â† c âŠ‘ op
    ! fn â‰¡ infn
    fn +â†© depth
    tail â† âŸ¨infnâˆ§fn,2-fnâŸ©/';'â€¿lf
    res â† do {ğ•ğ•©}Â¨ <line
    line.Finish @
    âˆ¾ resâˆ¾<tail
  }âŸ(0<â‰ )
  l â† ProcLineÂ¨ lf ((âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢) ğ•©
  "Unclosed function" ! 0â‰¡fn
  âˆ¾ âŸ¨preludeâŸ©âˆ¾l
}

StartLine â† { ğ•Š str:
  Assert â† { ! âˆ¾ğ•¨â€¿": `"â€¿strâ€¿"`" }âŸ(1â‰¢âŠ¢)
  tok â† ' ' ((âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢) str
  i â† Â¯1
  Next â‡ {ğ•¤
    i +â†© 1
    "Unfinished line" Assert i < â‰ tok
    i âŠ‘ tok
  }
  All â‡ {ğ•¤
    râ†(i+1)â†“tok â‹„ iâ†©1-Ëœâ‰ tok â‹„ r
  }
  Finish â‡ {ğ•¤
    IsWS â† âˆŠâŸœ(" "âˆ¾@+9)
    "Excessive IR line" Assert (â‰ tok) â‰¤â—¶âŸ¨(âˆ¨Â´ IsWS âˆ¨ Â·âˆ¨`'#'âŠ¸=)âŠ‘Ëœ, 1âŸ© i+1
  }
}

as â† {
  Name â‡ âŠ¢
  Rename â‡ "si_"âŠ¸âˆ¾
  I32 â‡ â€¢BQN
  Lit â‡ {
    vâ€¿t â† (1-Ëœ+`Ã—Â¬)âˆ˜(1âŒ¾âŠ‘':'âŠ¸=)âŠ¸âŠ” ğ•©
    âˆ¾âŸ¨"((",Type t,")",v,('u'=âŠ‘t)/"u","ll)"âŸ©
  }âŸ('!'=âŠ‘)
  Type â‡ { ğ•Šs:  # Singeli type to native
    s â†“Ëœâ†© ptrs â† +Â´âˆ§`'*'=s
    am â† ('['=âŠ‘)â—¶Â¯1â€¿{
      aâ€¿t â† (1-Ëœ+`Ã—Â¬)âˆ˜(1âŒ¾âŠ‘']'âŠ¸=)âŠ¸âŠ” ğ•©
      sâ†©t â‹„ â€¢BQN a
    } s
    arch.Type {
      "void": 'v'â€¿0â€¿Â¯1â€¿ptrs;
      âŸ¨âŠ‘ğ•©, â€¢BQN 1â†“ğ•©, am, ptrsâŸ©
    } s
  }
}

Nameâ€¿Renameâ€¿Typeâ€¿Litâ€¿I32 â† {ğ•{ğ•©.Next@}}Â¨ âŸ¨as.Name,as.Rename,as.Type,as.Lit,as.I32âŸ©
All â† {ğ•©.All@}

Join â† {âˆ¾1â†“â¥Š(<ğ•¨)â‰Ë˜ğ•©}
List â† ", "âŠ¸Join

BeginFn â† {ğ•¤
  n â† Rename ğ•©
  ret â† Type ğ•©
  argc â† I32 ğ•©
  param â† List ((Typeğ•©Ë™)âˆ¾" v"âˆ¾â€¢Repr)Â¨ â†•argc
  âˆ¾âŸ¨"static ",ret," ",n,"(",param,") {"âŸ©
}
Export â† {
  val â† Rename ğ•©
  ret â† Type ğ•©
  aname â† ("v"âˆ¾â€¢Repr)Â¨ â†•â‰  atype â† (Typeğ•©Ë™)Â¨ â†•I32 ğ•©
  exp â† Name ğ•©
  param â† ","Join atype {âˆ¾ğ•¨â€¿" "â€¿ğ•©}Â¨ aname
  in â† ","Join aname
  âˆ¾âŸ¨ret," ",exp,"(",param,") { return ",val,"(",in,"); }"âŸ©
}
âŸ¨NewâŸ© â† {
  Call â† {ğ•¨â€¿"("â€¿ğ•©â€¿")"}âŸœList
  codeâ€¿op â† <Ë˜â‰>âŸ¨
    "val" â€¿(â‰â—‹< Lit)
    "call"â€¿{ fn â† Rename ğ•© â‹„ fn Call (Litğ•©Ë™)Â¨ â†•I32 ğ•© }
    "emit"â€¿(Name (â‰¡âŸœ"op")â—¶âŸ¨
        CallâŸœ(as.LitÂ¨All)
        { oâ†Name ğ•© â‹„ âŸ¨Lit ğ•©," ",o," ",Lit ğ•©âŸ© }
      âŸ© âŠ¢)
  âŸ©
  New â‡ {
    id   â† Name ğ•©
    kind â† Name ğ•©
    ty   â† Type ğ•©
    pre â† "void"âŠ¸â‰¢â—¶âŸ¨âŸ¨âŸ©, {ğ•©â€¿" "â€¿idâ€¿" = "}âŸ© ty
    c â† codeâŠ¸âŠâŒ¾< kind
    (âˆ¾"Unknown new: `"â€¿kindâ€¿"`") ! c<â‰ code
    âˆ¾ pre âˆ¾ (câŠ‘op) {ğ•ğ•©} ğ•©
  }
}

codeâ€¿op â† (âŠ‘Â¨ â‰â—‹< 1âŠ¸â†“Â¨) âŸ¨
  "export" â€¿ 0â€¿0â€¿âŸ¨ExportâŸ©
  "beginFn"â€¿ 1â€¿0â€¿âŸ¨BeginFnâŸ©
  "lbl"    â€¿ 0â€¿1â€¿âŸ¨Name,":"âŸ©
  "ret"    â€¿ 0â€¿1â€¿âŸ¨"  ","return","void"âŠ¸â‰¢â—¶âŸ¨""," "âŠ¸âˆ¾âŸ© LitâŸ©
  "gotoF"  â€¿ 0â€¿1â€¿âŸ¨"  ","if (!(",Lit,")) ","goto ",NameâŸ©
  "gotoT"  â€¿ 0â€¿1â€¿âŸ¨"  ","if (",Lit,") ","goto ",NameâŸ©
  "goto"   â€¿ 0â€¿1â€¿âŸ¨"  ","goto ",NameâŸ©
  "new"    â€¿ 0â€¿1â€¿âŸ¨"  ",NewâŸ©
  "mut"    â€¿ 0â€¿1â€¿âŸ¨"  ",Name," = ",LitâŸ©
  "endFn"  â€¿Â¯1â€¿1â€¿âŸ¨"}"âŸ©
âŸ©

â€¢Out Generate â€¢FChars âŠ‘â€¢args
