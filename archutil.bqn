# CPU architecture definitions and utilities

Spl â† (âŠ¢-Ëœ+`Ã—Â¬)âˆ˜=âŠ”âŠ¢
ToUpper â‡ ((-Â´"Aa")Ã—'a'âŠ¸â‰¤âˆ§â‰¤âŸœ'z')âŠ¸+
TSort â† {{ğ•ŠâŸ(ğ•©<â—‹â‰ âŠ¢)âŸœ(ğ•©âˆ¾Â·/ğ•¨âŠ¸<)ğ•¨âˆ¨âˆ§Â´âˆ˜âŠâŸœğ•¨Â¨p}âŸœ/0Â¨pâ†ğ•©} # Topological sort

ReadDeps â† { ' ' SplÂ¨ â€¢file.Lines âˆ¾"data/"â€¿ğ•©â€¿"_ext.txt" }
ReadFeats â† { âŸ¨ğ•¨âŸ© âˆ¾ â·âˆ¾ ReadDeps ğ•© }

MakeArch â‡ {
  nameâ€¿widthâ€¿VecType â‡ ExtFileâ€¿header â† ğ•©
  infer â† ğ•¨âŠ£0
  Headers â‡ {(ğ•©>0)/âŸ¨headerâŸ©}
  # d is a list of extension dependency chains
  u â† â·âˆ¾ d â† ReadDeps ExtFile infer
  u âŠËœâ†© TSort âˆ¾Â¨ (âŠ¢âŠ”â—‹âˆ¾(Â¯1â†“â†‘)Â¨) (<u)âŠÂ¨d
  # Unique feature flags including arch name
  feats â‡ âŸ¨nameâŸ© âˆ¾ u
  # Make a dependency matrix: iâ€¿jâŠ‘m is 1 iff feature i depends on j
  GetMat â‡ {ğ•Š:
    m â† (â‰¥âŒœËœâ†•âˆ˜â‰ )âŠ¸Ã—âˆ¨Â´Ã—âŒœËœÂ¨(<u)âˆŠÂ¨d # Dependencies from file
    m âˆ¨Ëâˆ˜âˆ§â‰1â€¿âˆËœâŸ(âŒˆ2â‹†â¼â‰ )â†©        # Transitive closure
    1 âˆ¾Ë˜ 0Â¨âˆ˜âŠâŠ¸âˆ¾ m               # Plus base architecture
  }
}

arches â‡ âŸ¨
  {
    name â‡ "X86_64"
    width â‡ 64
    ExtFile â‡ {ğ•©âŠ‘"x86_strict"â€¿"x86"}
    feats â‡ name ReadFeats ExtFile 0
    header â‡ "immintrin.h"
    us â† "Unsupported vector type"
    VecType â‡ {
      ğ•Š 1â€¿âŸ¨vâŸ©â€¿1â€¿0: vâ‰¤64?
        us ! âˆŠâŸœ(2â‹†3+â†•4)âŒ¾<v      # 8â€¦64
        âŸ¨4, "__mmask"âˆ¾â€¢Repr vâŸ©; # AVX-512 mask
      ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f:
        us ! âˆŠâŸœ(2â‹†6+â†•4)âŒ¾<lâ†wÃ—v  # 64â€¦512
        âŸ¨5-Ëœ2â‹†â¼l, âˆ¾âŸ¨"__m", â€¢Repr l, {l=64?"";Â¬f?"i";(64=w)/"d"}âŸ©âŸ©;
      !"Nested vector type unsupported in x86"
    }
    mainDefine â‡ "__x86_64__"
    StripDefines â‡ { u â† "__" â‹„ (Â¯2â†“2â†“âŠ¢)Â¨ ((uâ‰¡2âŠ¸â†‘)âˆ§uâ‰¡Â¯2âŠ¸â†‘)Â¨âŠ¸/ ğ•© }
  }
  {
    name â‡ "AARCH64"
    width â‡ 64
    feats â‡ name ReadFeats extfile â‡ "armv8"
    header â‡ "arm_neon.h"
    VecType â‡ {
      ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f:
        1 â‹ˆ âˆ¾âŸ¨{f?"float"; (u/"u")âˆ¾"int"}, â€¢Repr w, "x", â€¢Repr v, "_t"âŸ©;
      !"Nested vector type not yet supported in ARM"
    }
    mainDefine â‡ "__aarch64__"
    StripDefines â‡ { lâ†â‰ preâ†"__ARM_FEATURE_" â‹„ lâ†“Â¨(preâ‰¡lâŠ¸â†‘)Â¨âŠ¸/ ğ•© }
  }
  {
    name â‡ "RV64"
    width â‡ 64
    feats â‡ name ReadFeats extfile â‡ "rv"
    header â‡ "riscv_vector.h"
    VecType â‡ {
      ğ•Š âŸ¨w, xâ€¿v, u, fâŸ©: 1 â‹ˆ âˆ¾âŸ¨Â¯2â†“1âŠ‘ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f, 'x', â€¢Repr x, "_t"âŸ©;
      ğ•Š 1â€¿âŸ¨vâŸ©â€¿1â€¿0:
        1 â‹ˆ âˆ¾âŸ¨"vbool", â€¢Repr 128Ã·v, "_t"âŸ©;
      ğ•Š wâ€¿âŸ¨vâŸ©â€¿uâ€¿f:
        lmul â† (vÃ—w)Ã·128
        mf â† lmul<1
        1 â‹ˆ âˆ¾âŸ¨"v", {f?"float"; (u/"u")âˆ¾"int"}, â€¢Repr w, "m", mf/"f", â€¢Repr Ã·âŸmf lmul, "_t"âŸ©;
      !"Only two levels of vector nesting supported in RISC-V"
    }
    mainDefine â‡ "__riscv_xlen"
    StripDefines â‡ { "RVV"Â¨ "__riscv_v"âŠ¸â‰¡Â¨âŠ¸/ ğ•© }
  }
âŸ©

allfeats â‡ âˆ¾ archfeats â‡ {ğ•©.feats}Â¨ arches

ReadNative â‡ {ğ•Š:
  f â† {
    c â† 1âŠ‘ â€¢SH "cat"â€¿"/proc/cpuinfo"
    l â† (âˆ¨Ë"flags"â€¿"Features"(âŠ£â‰¡â‰ âŠ¸â†‘)âŒœâŠ¢)âŠ¸/ (@+10) Spl c  # Line with flags
    0<â‰ l ? ToUpperÂ¨ 1â†‘l
  ;
    l â† (@+10) Spl (1âŠ‘â€¢SH)âŠâŸ¨âŸ© "sysctl"â€¿"machdep.cpu" # For macs
    0<â‰ l ? {
      âˆ¨Â´(âˆ¨Â´"feature"âŠ¸â·)Â¨l ? l
    ;
      l â† (@+10) Spl 1âŠ‘ â€¢SH "sysctl"â€¿"hw.optional" # ARM
      â‹ˆToUpper ":"âˆ¾ âˆ¾ {" "âˆ¾(âˆ§`âŒ¾âŒ½Â·Â¬âˆŠâŸœ"_.")âŠ¸/(âˆ§`':'âŠ¸â‰ )âŠ¸/ğ•©}Â¨ ('0'â‰ âŠ¢Â´Â¨)âŠ¸/ l
    }
  ;
    ! "Couldn't find CPU features"
  }
  f â†© âˆ¾ (' ' Spl 2â†“(âˆ¨`':'âŠ¸=)âŠ¸/)Â¨ f
  f â†© "PNI"â€¿"BMI1"â€¿"PCLMULQDQ"â€¿"AVX1.0"âŠ¸âŠâŠ¸(âŠ£â—¶âŸ¨"SSE3",Â¯1âŠ¸â†“,Â¯3âŠ¸â†“,Â¯3âŠ¸â†“,âŠ¢âŸ©Â¨) f
  f â†© '_'âŠ¸â‰ âŠ¸/âŸ("AVX512"(âŠ£â‰¡â‰ âŠ¸â†‘)âŠ¢)Â¨ f
  âˆŠâŸœallfeatsâŠ¸/ ((-Â´"._")Ã—'_'âŠ¸=)âŠ¸+ f
}

# Get extension list from a list of C defines as returned by cc -dM -E
ParseCDefines â‡ { ğ•Š lines:
  pre â† "#define "
  ! âˆ§Â´ preâŠ¸(âŠ£â‰¡â‰ âŠ¸â†‘)Â¨ lines
  names â† (âˆ§`' 'âŠ¸â‰ )âŠ¸/Â¨ (â‰ pre)âŠ¸â†“Â¨ lines
  as â† ({ğ•©.mainDefine}Â¨ âˆŠ namesË™)âŠ¸/ arches
  0 < â‰ as?
  arch â† âŠ‘ as
  âŸ¨arch.nameâŸ© âˆ¾ âˆŠâŸœarch.featsâŠ¸/ ((-Â´"._")Ã—'_'âŠ¸=)âŠ¸+ arch.StripDefines names
  ; âŸ¨"NONE"âŸ©
}
