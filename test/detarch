#! /usr/bin/env bqn
# Architecture detection tests

Has â† âˆŠâŸœâ€¢argsâŒ¾<

âŸ¨FindBitPackerâŸ© â† â€¢Import "../detarch.bqn"
CheckBitPack â† {
  S â† { ! Â¬âˆ¨Â´ğ•¨â†‘ğ•© â‹„ ğ•¨âŒ½ğ•© }         # Shift
  A â† { ! âˆ§Â´ğ•¨(Â¯1âŠ¸Â»âŠ¸<âˆ§â‰¥)â—‹/ğ•© â‹„ ğ•¨ } # Add-mask
  ! (0<â‰ )â—¶1â€¿(âˆ§Â´ 1â‰¥Â·+Â´ FindBitPacker (=âŠ£)â—¶Sâ€¿AÂ¨ âŠ¢) ğ•©
}
run â† (Has "check") âŠ‘ FindBitPackerâ€¿CheckBitPack

cn â† 7â†“Â¨ cl â† â€¢file.Lines "../data/x86_cpuid.txt"
ci â† âŠ3â†‘Â¨cl â‹„ cr â† (â€¢ParseFloat Â·(' '=âŠ‘)âŠ¸â†“2â†‘4âŠ¸â†“)Â¨cl

de â† â· âˆ¾ ' 'âŠ¸(âŠ¢âŠ”Ëœ=-Ëœ+`âˆ˜=Ã—â‰ )Â¨ â€¢file.Lines "../data/x86_ext.txt"
arch â† deâ€¿0 â€¢Import "../arch.bqn"
f â† arch.feats
f /Ëœâ†© fm â† fâˆŠcn
# All possible dependency-resolved feature combinations
combs â† (â‰0Â¨f) (â·âŠ¢âˆ¾âˆ¨â‰1)Ë fmâ€¿fm/arch.mat
{ âˆ¨Â´aâ†"-n"âŠ¸â‰¡Â¨â€¢args ?
  n â† â€¢ParseFloat â‹ˆâ¼(Â»a)/â€¢args
  combs (n (â€¢MakeRand 1).Subset â‰ )âŠ¸âŠâ†©
;@}

cf â† fâŠcn â‹„ cs â† cr {ğ•©âŒ¾(ğ•¨âŠ¸âŠ)32â¥Šâ‰ f}Â¨â—‹(ciâŠ¸âŠ”) cf
inputs â† <âˆ˜{âˆ¨Â´Â¨âŠ¸/ âŠâŸœ(ğ•©âˆ¾0)Â¨ cs}Ë˜ combs
ttâ†â€¢MonoTime@ â‹„ t â† Runâ€¢_timedÂ¨ inputs â‹„ tt-Ëœâ†©â€¢MonoTime@

{ Has "bench" ?
  â€¢OutâŸ(Has"check") "(Timings include result check)"
  Ro â† âŒŠ0.5âŠ¸+ â‹„ Us â† 1e6âŠ¸Ã— â‹„ Ru â† Ro Us
  â€¢Out âˆ¾â€¢ReprâŸ(0==)Â¨âŸ¨"Total time: ",RoâŒ¾Us tt," (",Ru ttÃ·â‰ inputs,"Î¼s avg)"âŸ©
  â€¢Out "Worst times (Î¼s):"âˆ¾âˆ¾(' 'âˆ¾â€¢Repr)Â¨ Ru (wâ†10)â†‘âˆ¨t
  { Has "retime" ?
  â€¢Out "Retimed:         "âˆ¾âˆ¾(' 'âˆ¾â€¢Repr)Â¨ Ru Runâ€¢_timedÂ¨ (wâ†‘â’t)âŠinputs
  ;@}
;@}
