# High-precision numbers as pairs representing unevaluated sums
# Format is âŸ¨high,lowâŸ©

To   â‡ â‹ˆâŸœ0
From â‡ +Â´

Add12 â† {ağ•Šb:
  s â† a + b
  {Â¬âˆ>|s ? sâ€¿0 ;
  avâ† s - bvâ† s - a
  âŸ¨s, +Â´aâ€¿b-avâ€¿bvâŸ© }
}
Add â‡ {ağ•Šb:
  r â† a +â—‹âŠ‘ b
  {Â¬âˆ>|r ? râ€¿0 ;
  s â† (-r) +Â´ Â¯1âŒ½âŒ½âŸ(a<â—‹(|âŠ‘)b) bâŒ½âŠ¸âˆ¾a
  r Add12 s }
}

Neg â‡ -
Abs â‡ -âŸ(0>âŠ‘)
Floorâ€¿Ceil â‡ {ğ•âˆ˜âŠ‘âŠ¸(âŠ£â‹ˆÂ·ğ•-âŠ¸(+Â´)âŸœâŒ½)}Â¨ âŒŠâ€¿âŒˆ
Sub â‡ AddâŸœNeg

Cmp â‡ Ã— Â· (0=âŠ‘)âŠ¸âŠ‘ Sub

Split â† 53â€¿1024{pâ€¿e _ğ•£:  # Double-precision float
  spâ† 1+2â‹†seâ†âŒˆpÃ·2
  m â† 2â‹†e-1+se â‹„ f â† 2â‹†-p  # Adjustments to avoid hitting âˆ
  {Â¬m>|ğ•©? ğ•ŠâŒ¾(fâŠ¸Ã—) ğ•©; ğ•Ša:
    c â† sp Ã— a
    alâ† a - ahâ† c - c - a
    âŸ¨al, ahâŸ© # Backwards for convenient reduction
  }
}
Mul12 â† {ağ•Šb:
  h â† a Ã— b
  {âˆ>|h? âŸ¨h, (-h) +Â´ â¥Š b Ã—âŒœâ—‹Split aâŸ© ; hâ€¿0}
}
Mul â‡ {ağ•Šb:
  phâ€¿pl â† a Mul12â—‹âŠ‘ b
  {âˆ>|âŠ‘ph? ph Add12 pl + +Â´ a Ã— âŒ½b ; phâ€¿0}
}

Div â‡ {bğ•Ša:
  yn â† (âŠ‘b) Ã— xn â† Ã·âŠ‘a
  {Â¬âˆ>|yn? ynâ€¿0 ;
  diff â† âŠ‘ b Sub a Mul ynâ€¿0
  ynâ€¿0 Add xn Mul12 diff }
}

Mod â‡ {
  bğ•Šaâ€¿0: a>0 ? hâ†aÃ·2 â‹„ Add12Â´ aâŠ¸+âŒ¾âŠ‘âŸ(<âŸœ-Â´) (-âŸœ(aÃ—h<âŠ¢)a|âŠ¢)âŸ(h<|)Â¨b ;
  # Not correctly rounded but probably okay
  bğ•Ša: a Sub b Mul (Floor a Div b)
}

# Decimal parsing
# For one double, max digits is 15 and max power of 10 is 1e22
Exp10 â† { 22â‰¥ğ•©? To 10â‹†ğ•©; 308<ğ•©? To âˆ; (âŠ£Â´MulâŠ¢Â´)ğ•ŠÂ¨â·âŒŠ2Ã·Ëœğ•©+â†•2 } # Could save results
N1 â† â€¢ParseFloat
Nat â† â‰ âŠ¸{
  15â‰¥ğ•¨ ? To N1 ğ•© ;
  20â‰¥ğ•¨ ? Â¯15 ((1e15Ã—N1âˆ˜â†“) Add12 N1âˆ˜â†‘) ğ•© ;  # Exact
  35â‰¥ğ•¨ ? Â¯20 ((1e20 Mul12 â€¢ParseFloatâˆ˜â†“) Add Natâˆ˜â†‘) ğ•© ; # Sum of exacts so it's correctly rounded
  (Exp10 ğ•¨-35) Mul Nat 35â†‘ğ•©  # Imprecise
}
ParseDec â‡ { # ğ•¨ is base-10 exponent; ğ•© is digit string
  0â‰¤ğ•¨ ? ğ•¨ Exp10âŠ¸MulâŸ(0<âŠ£) Nat ğ•© ;
  (ğ•¨â†“ğ•©) NatâŠ¸AddâŸ(0<â‰ âˆ˜âŠ£) (Exp10-ğ•¨) DivËœ Nat (ğ•¨âŒˆ-â‰ ğ•©)â†‘ğ•©
}

_repr â‡ { lenâ€¿b _ğ•£:
  ! âŒŠâŠ¸= 2â‹†â¼b # Need division by b to be exact
  {câ†0 â‹„ {ğ•©+â†©câ‹„câ†©âŒŠğ•©Ã·bâ‹„b|ğ•©}Â¨ğ•©} Â·+Â´ b|âŒŠâˆ˜Ã·âŸœbâŸ(â†•len)Â¨
}
Bits â‡ {
  ğ•Šâ¼ğ•©: (2â‹†48)âŠ¸Ã—âŠ¸Add12Ëœâ—‹(2âŠ¸Ã—âŠ¸+ËœÂ´)Ë 2â€¿âˆ˜â¥Šğ•© ;
  âˆ§Â´ğ•©=âŸœ1âŠ¸âˆ¨âŒ¾âŠ‘ğ•©=0 ? 96â†‘âŠğ•© ;
  "Bitwise operation: arguments must be unsigned integers" ! âŒŠâŠ¸â‰¡â—¶âŸ¨0,>âŸœ-Â´âŸ© ğ•©
  "Bitwise operation: arguments can't exceed 2^96" ! 0<(2â‹†96)-ËœÂ´âŒ½ğ•©
  96â€¿2 _repr ğ•©
}
