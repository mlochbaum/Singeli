# High-precision numbers as pairs representing unevaluated sums
# Format is âŸ¨high,lowâŸ©

To   â‡ â‹ˆâŸœ0
From â‡ +Â´

Add12 â† {ağ•Šb:
  s â† a + b
  avâ† s - bvâ† s - a
  âŸ¨s, +Â´aâ€¿b-avâ€¿bvâŸ©
}
Add â‡ {ağ•Šb:
  r â† a +â—‹âŠ‘ b
  s â† (-r) +Â´ Â¯1âŒ½âŒ½âŸ(a<â—‹(|âŠ‘)b) bâŒ½âŠ¸âˆ¾a
  r Add12 s
}

Neg â‡ -
Abs â‡ -âŸ(0>âŠ‘)
Floorâ€¿Ceil â‡ {ğ•âˆ˜âŠ‘âŠ¸(âŠ£â‹ˆÂ·ğ•-âŠ¸(+Â´)âŸœâŒ½)}Â¨ âŒŠâ€¿âŒˆ
Sub â‡ AddâŸœNeg

Cmp â‡ Ã— Â· (0=âŠ‘)âŠ¸âŠ‘ Sub

p â† 53  # Double-precision float
Split â† (1+2â‹†âŒˆpÃ·2){sp _ğ•£ a:
  c â† sp Ã— a
  alâ† a - ahâ† c - c - a
  âŸ¨al, ahâŸ© # Backwards for convenient reduction
}
Mul12 â† {ağ•Šb:
  h â† a Ã— b
  âŸ¨h, (-h) +Â´ â¥Š b Ã—âŒœâ—‹Split aâŸ©
}
Mul â‡ {ağ•Šb:
  phâ€¿pl â† a Mul12â—‹âŠ‘ b
  ph Add12 pl + +Â´ a Ã— âŒ½b
}

Div â‡ {bğ•Ša:
  yn â† (âŠ‘b) Ã— xn â† Ã·âŠ‘a
  diff â† âŠ‘ b Sub a Mul ynâ€¿0
  ynâ€¿0 Add xn Mul12 diff
}

Mod â‡ {
  bğ•Šaâ€¿0: a>0 ? hâ†aÃ·2 â‹„ Add12Â´ aâŠ¸+âŒ¾âŠ‘âŸ(<âŸœ-Â´) (h-Ëœa|h+âŠ¢)âŸ(h<|)Â¨b ;
  # Not correctly rounded but probably okay
  bğ•Ša: a Sub b Mul (Floor a Div b)
}

_repr â‡ { lenâ€¿b _ğ•£:
  ! âŒŠâŠ¸= 2â‹†â¼b # Need division by b to be exact
  {câ†0 â‹„ {ğ•©+â†©câ‹„câ†©âŒŠğ•©Ã·bâ‹„b|ğ•©}Â¨ğ•©} Â·+Â´ b|âŒŠâˆ˜Ã·âŸœbâŸ(â†•len)Â¨
}
Bits â‡ {
  ğ•Šâ¼ğ•©: (2â‹†48)âŠ¸Ã—âŠ¸Add12Ëœâ—‹(2âŠ¸Ã—âŠ¸+ËœÂ´)Ë 2â€¿âˆ˜â¥Šğ•© ;
  âˆ§Â´ğ•©=âŸœ1âŠ¸âˆ¨âŒ¾âŠ‘ğ•©=0 ? 96â†‘âŠğ•© ;
  "Bitwise operation: arguments must be unsigned integers" ! âŒŠâŠ¸â‰¡â—¶âŸ¨0,>âŸœ-Â´âŸ© ğ•©
  "Bitwise operation: arguments can't exceed 2^96" ! 0<(2â‹†96)-ËœÂ´âŒ½ğ•©
  96â€¿2 _repr ğ•©
}
